<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>ConcurrentReader by AlienEngineer</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>ConcurrentReader</h1>
        <p>IDataReader made Thread-Safe</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.com/AlienEngineer/ConcurrentReader" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.com/AlienEngineer/ConcurrentReader/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.com/AlienEngineer/ConcurrentReader/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h2>Objective</h2>

<p>Improve performance of data reading by using concurrency. Making a IDataReader wrapper Thread-Safe.</p>

<h2>Solution</h2>

<p>The call to the IDataReader Read() Method starts a loaderThread that loads all records into a List.
<img src="https://raw.github.com/AlienEngineer/ConcurrentReader/master/Doc/b8b4b6f3.png" alt="Flow"></p>

<p>From this point on the Read() Method is used to allocate data from the List to the Current Thread. When the current thread tries to read that it will actually get data from a Tuple type.</p>

<p>This solution enables the reading process to be as quick as possible making sure the database is released as soon as the data is loaded. Not having to wait for the data computation.</p>

<h2>Extensions</h2>

<p>The reader can be used in concurrency with other threads any way you wish. Still there are a few extension methods to ease some pain.</p>

<div class="highlight"><pre><span class="c1">// Returns some IDataReader implementation...</span>
<span class="n">IDataReader</span> <span class="n">reader</span> <span class="p">=</span> <span class="n">GetReader</span><span class="p">();</span>
<span class="c1">// Wraps the IDataReader with ConcurrentDBReader </span>
<span class="c1">// making it Thread-Safe</span>
<span class="n">ConcurrentDBReader</span> <span class="n">cReader</span> <span class="p">=</span> <span class="n">reader</span><span class="p">.</span><span class="n">MakeConcurrent</span><span class="p">();</span> 

<span class="kt">int</span> <span class="n">records</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>

<span class="c1">// The ForEach creates Tasks to execute asynchronously the work</span>
<span class="n">reader</span><span class="p">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="c1">// Independent operation </span>
    <span class="n">Compute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
    <span class="c1">// Dependent operation therefore the </span>
    <span class="c1">// Interlocked.Increment to be synchronized.</span>
    <span class="n">Interlocked</span><span class="p">.</span><span class="n">Increment</span><span class="p">(</span><span class="k">ref</span> <span class="n">records</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>To make thing a bit more easy it is possible to get a full line as a ITuple type.</p>

<div class="highlight"><pre><span class="n">reader</span><span class="p">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">r</span> <span class="p">=&gt;</span> 
<span class="p">{</span>
    <span class="n">ITuple</span> <span class="n">tuple</span> <span class="p">=</span> <span class="n">r</span><span class="p">.</span><span class="n">GetData</span><span class="p">();</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">"E-mail dated with {0} was sent..."</span><span class="p">,</span> 
                      <span class="n">tuple</span><span class="p">.</span><span class="n">GetValue</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;());</span>
    <span class="n">SendEMail</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>

<p>Still the regular use has the advantage of the reading lock getting released as soon as the data is loaded and not when all the computations are done.</p>

<div class="highlight"><pre><span class="k">try</span>
<span class="p">{</span>
    <span class="k">while</span><span class="p">(</span><span class="n">reader</span><span class="p">.</span><span class="n">Read</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">Compute</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">finally</span> 
<span class="p">{</span>
    <span class="n">reader</span><span class="p">.</span><span class="n">Close</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/AlienEngineer">AlienEngineer</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>